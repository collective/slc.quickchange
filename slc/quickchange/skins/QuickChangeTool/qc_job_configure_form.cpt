<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"
      lang="en"
      metal:use-macro="here/main_template/macros/master"
      i18n:domain="plone">
      
<head>
  <metal:ajax fill-slot="javascript_head_slot">
    <script src="/prototype.js" type="text/javascript"></script>
    <script src="/scriptaculous.js" type="text/javascript"></script>
    
<script type="text/javascript" language="JavaScript">

var urlcomp = document.URL.split("/");
urlcomp.pop();

function retrieveSearchResults() {
    var targeturl = urlcomp.join("/")+'/retrieveSearchResults';
    var catsearch = new Ajax.Updater( 'search-result-list', 
                                      targeturl, 
                                      { method: 'get', 
                                        onLoading:function(request){
                                            Element.show('indicator');
                                        }, 
                                        onComplete: function(request){ 
                                            Element.hide('indicator');
                                            Sortable.create('search-result-list',
                                                    {dropOnEmpty: true, 
                                                     ghosting:false,
                                                     constraint:false,
                                                     containment:['search-result-list','target-object-list']
                                                    });
                                                },
                                        asynchronous: true,
                                        parameters: 'path='+encodeURIComponent($('search_path').value)+'&SearchableText='+encodeURIComponent($('searchtext').value),
                                      } 
                                     );
    
}    



function saveTargets() {
    var targeturl = urlcomp.join("/")+'/saveTargets';
    var ser = Sortable.serialize('target-object-list');
    new Ajax.Updater('save-target-msg', 
                targeturl, 
                {onLoading:function(request){
                    Element.show('indicator');
                 }, 
                 onComplete:function(request){
                        Element.hide('indicator');
                 }, 
                 parameters:qs=encodeURIComponent(ser), 
                 evalScripts:true, 
                 method: 'GET',
                 asynchronous:true
                 }
                );
}



function showIndicator(req) {
    Element.show('indicator');
}
function createTargetObjectSortable(req) {
    Sortable.create('target-object-list',
        {dropOnEmpty: true, 
         ghosting:false,
         constraint:false,
         containment:['search-result-list','target-object-list']
        });
    Element.hide('indicator');
}


function loadPool() {
    var targeturl = urlcomp.join("/")+'/ajax_LoadPool';
    new Ajax.Updater('target-object-list', 
                    targeturl, 
                    {
                        onLoading:showIndicator, 
                        onComplete:createTargetObjectSortable, 
                        evalScripts:true, 
                        method: 'GET',
                        asynchronous:false,
                 }
                );
}


function clearPool() {
    $('target-object-list').innerHTML = '';
    Sortable.create('target-object-list',
        {dropOnEmpty: true, 
         ghosting:false,
         constraint:false,
         containment:['search-result-list','target-object-list']
        });    
    var targeturl = urlcomp.join("/")+'/saveTargets';
    new Ajax.Updater('save-target-msg', 
                targeturl, 
                {onLoading:function(request){
                    Element.show('indicator');
                 }, 
                 onComplete:function(request){
                        Element.hide('indicator');
                 }, 
                 parameters:qs='', 
                 evalScripts:true, 
                 method: 'GET',
                 asynchronous:true
                 }
                );
}
function PoolSlideDown() {
    Effect.SlideDown('droparea', {duration: 0.5});       
    Element.hide('qc-arrow-down');
    Element.show('qc-arrow-up');
}

function PoolSlideUp() {
    Effect.SlideUp('droparea', {duration: 0.5});
    Element.hide('qc-arrow-up');
    Element.show('qc-arrow-down');
}

function removeItem(item) {
    Element.remove(item);
}
function addAllResults() {
    var sres = $('search-result-list').innerHTML;
    var tres = $('target-object-list').innerHTML;
    $('target-object-list').innerHTML = sres+'\n'+tres;
    $('search-result-list').innerHTML = '';
    Sortable.create('target-object-list',
        {dropOnEmpty: true, 
         ghosting:false,
         constraint:false,
         containment:['search-result-list','target-object-list']
        });
}

function initQC() {
    loadPool();
}
</script>
  </metal:ajax>
  
  
  <metal:css fill-slot="css_slot">

  <style>
  #droparea {
      /*display: none;*/
  }
  #qc-arrow-up {
      /*display:none;*/
  }
  #move-controls {
    padding: 5px;
  }
  #search-results {
    width: 100%;
  }
  #target-objects {
    width: 100%;
  }    
  #target-objects, #search-results {
    height: 150px;
    background: #fff;
    border:1px solid #888;
    overflow:auto;
  }
  #target-objects ul, #search-results ul {
    list-style-type:none;
    list-style-image:none;
    margin:0;
    padding:0;
    width:100%;
  }

  #search-results ul li.result_record {
    background-color: #ECF3E1;
    border:1px solid #C5DEA1;
    cursor: move;
    margin:0;
    padding:3px;
  } 
  #target-objects ul li.result_record {
    border:1px solid #E8A400;
    background-color: #FFF4D8;
    cursor: move;
    margin:0;
    padding:3px;
  } 
  
  #search-results ul li.selected,
  #target-objects ul li.selected { 
    background-color: #ffb; 
  }
  #target-object-list {
      width: 100%;
      height: 150px;
  }
  #save-target-msg {
    color: black;
    background-color: orange;
    border: 1px dashed red;
    font-size: 80%;   
    padding: 5px; 
    display: none;
  }
  div.dropmarker {
      height:6px;
      width:300px;
      background: url(/images/dropmarker.png) left top;
      margin-top:-3px;
      margin-left:-5px;
      z-index:1000;
      overflow: hidden;
   }  
   
</style>
  </metal:css>

</head>

<body>

<div metal:fill-slot="main">




<h1>Job Configuration</h1>

  <fieldset>
  
    <legend i18n:translate="legend_qc_searchform">Select objects</legend>

    <div>
        Path: <input id="search_path" name="path" size="40" type="text" value="/osha/portal/data" />
    </div>
    
    <div>
        Fulltext search: <input id="searchtext" name="SearchableText" size="40" type="text" value="osha" />
    </div>
    
    <input type="Button" onClick="retrieveSearchResults()" value="Search">
    
    <div id="dragarea">
        <h3>Search results</h3>
        <div id="search-results">
            <ul id="search-result-list">
            </ul>
        </div>
    </div>
    
    <br clear="all"/>
    
    <div id="move-controls">
        <input type="Button" id="add-results-button" value="Add all Results" onClick="addAllResults()">
    </div>
    
    <p id="indicator" style="display:none; margin-top:0px;">
      <img alt="Indicator" src="/indicator_web20_working.gif" /> Updating ...
    </p>
  </fieldset>

  
  <fieldset>
  
    <legend>
        <a href='javascript:return false;' onClick="PoolSlideDown();return false;"><img id="qc-arrow-down" src="/qc_arrowDown.gif"></a> 
        <a href='javascript:return false;' onClick="PoolSlideUp(); return false;"><img id="qc-arrow-up" src="/qc_arrowUp.gif"></a> 
        <span i18n:translate="legend_qc_searchpool">Search Pool</span>
    </legend>
    
    <div id="save-target-msg"></div>
    
    
    <div id="droparea">
        <input type="Button" id="reset-target-button" onClick="loadPool()" value="Reset Pool">
        <input type="Button" id="clear-target-button" onClick="clearPool()" value="Clear Pool">
        <input type="Button" id="save-target-button" onClick="saveTargets()" value="Save Pool">
        <h3>Selected Objects</h3>
        <div id="target-objects">
            <ul id="target-object-list">
            </ul>
        </div>
    </div>
  </fieldset>

<script language="JavaScript">initQC();</script>
</div>

</body>
</html>
